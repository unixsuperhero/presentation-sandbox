#!/bin/bash

set -e

if [[ -z "$1" ]]; then
  echo "Usage: ./run <number|name>"
  echo "  ./run 1          # matches 001.fundamentals"
  echo "  ./run fund       # matches 001.fundamentals"
  exit 1
fi

arg="$1"
matches=()

# If arg is a number, zero-pad it to 3 digits
if [[ "$arg" =~ ^[0-9]+$ ]]; then
  padded=$(printf "%03d" "$arg")
  for dir in workspaces/*/; do
    dirname=$(basename "$dir")
    if [[ "$dirname" == "$padded"* ]]; then
      matches+=("$dirname")
    fi
  done
else
  # Match against the name part (after the number prefix)
  for dir in workspaces/*/; do
    dirname=$(basename "$dir")
    if [[ "$dirname" == *"$arg"* ]]; then
      matches+=("$dirname")
    fi
  done
fi

if [[ ${#matches[@]} -eq 0 ]]; then
  echo "No workspace found matching: $arg"
  exit 1
elif [[ ${#matches[@]} -gt 1 ]]; then
  echo "Multiple workspaces match '$arg':"
  for match in "${matches[@]}"; do
    echo "  $match"
  done
  exit 1
fi

selected="${matches[0]}"
workspace_path="workspaces/$selected"
echo "Selecting workspace: $selected"

# Ensure workdir exists
if [[ ! -d "$workspace_path/workdir" ]]; then
  echo "Error: $workspace_path/workdir does not exist"
  echo "Workspace structure should be: workspaces/NAME/workdir/"
  exit 1
fi

# Remove existing workspace symlink if present
if [[ -L workspace ]]; then
  rm workspace
elif [[ -e workspace ]]; then
  echo "Error: workspace exists but is not a symlink"
  exit 1
fi

# Link to workdir subdirectory
ln -s "$workspace_path/workdir" workspace
echo "Linked workspace -> $workspace_path/workdir"

# Extract workspace name without the number-dot prefix (e.g., "001.fundamentals" -> "fundamentals")
workspace_name="${selected#*.}"
echo "export STARSHIP_CONTAINER_NAME=\"$workspace_name\"" > config/.zshrc.workspace

# Parse workspace.yml and generate docker-compose override
workspace_yml="$workspace_path/workspace.yml"
override_file="docker-compose.override.yml"

# Default values
image_target="full"
hiiro_enabled="true"
workspace_volumes=()
skip_nvim_data="false"

# Parse workspace.yml if it exists
if [[ -f "$workspace_yml" ]]; then
  echo "Reading workspace configuration from $workspace_yml"

  # Use Ruby to parse YAML
  eval "$(ruby -ryaml -e '
    config = YAML.load_file(ARGV[0]) rescue {}
    workspace_path = ARGV[1]

    puts "image_target=\"#{config["image"] || "full"}\""

    shell = config["shell"] || {}
    puts "hiiro_enabled=\"#{shell["hiiro"] != false}\""

    # Process volumes as key-value pairs (src: dest)
    volumes = config["volumes"] || {}
    volumes.each do |src, dest|
      # Resolve source path based on prefix
      resolved_src = case src
        when /^\//        # Absolute path
          src
        when /^\.\//      # Relative to workspace dir
          "./#{workspace_path}/#{src[2..]}"
        else              # Relative to repo root
          "./#{src}"
        end

      puts "workspace_volumes+=(\"#{resolved_src}:#{dest}\")"

      # Check if this mounts over nvim-data location
      if dest == "/root/.local/share/nvim"
        puts "skip_nvim_data=\"true\""
      end
    end
  ' "$workspace_yml" "$workspace_path" 2>/dev/null)" || true
fi

echo "Configuration: image=$image_target, hiiro=$hiiro_enabled"

# Generate docker-compose.override.yml
cat > "$override_file" << OVERRIDE
services:
  sandbox:
    build:
      target: $image_target
    environment:
      - HIIRO_ENABLED=$hiiro_enabled
    volumes:
      - ./workspace:/sandbox
      - ./config/.zshrc:/root/.zshrc
      - ./config/.zshrc.workspace:/root/.zshrc.workspace
      - ./config/.gitconfig:/root/.gitconfig
      - ./config/.gitignore.global:/root/.gitignore.global
      - ./config/.tmux.conf:/root/.tmux.conf
      - ./config/git:/root/.config/git
      - ./config/ssh:/root/.ssh
      - ./config/starship:/root/.config/starship
      - ./config/broot:/root/.local/share/broot
      - ./config/demo.nvim:/root/.local/share/nvim/lazy/demo.nvim
      - ./config/bin:/root/bin
      - ./config/nvim:/root/.config/nvim
OVERRIDE

# Add nvim-data volume unless workspace overrides it
if [[ "$skip_nvim_data" != "true" ]]; then
  echo "      - nvim-data:/root/.local/share/nvim" >> "$override_file"
fi

# Add workspace-specific volumes
for vol in "${workspace_volumes[@]}"; do
  echo "      - $vol" >> "$override_file"
  echo "Adding volume: $vol"
done

# Build the correct image target before running
echo "Building image with target: $image_target"
docker-compose -f docker-compose.yml -f "$override_file" build sandbox

# Run docker-compose with override
docker-compose -f docker-compose.yml -f "$override_file" run --rm sandbox

# Run optional workspace cleanup script
cleanup_script="$workspace_path/cleanup"
if [[ -x "$cleanup_script" ]]; then
  echo "Running cleanup script: $cleanup_script"
  "$cleanup_script"
fi

# Cleanup
ls -ld workspace
rm -iv workspace
rm -f "$override_file"
